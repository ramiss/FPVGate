name: Build Validation

# Lightweight build validation for pull requests
# Validates that code compiles for all board types without uploading firmware
# Saves Actions minutes by running compilation checks only (~2-3 min vs 15-20 min)

on:
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - 'src/**'
      - 'test/**'
      - 'platformio.ini'
      - '.github/workflows/build-validation.yml'

jobs:
  build-validation:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Cache PlatformIO
      uses: actions/cache@v4
      with:
        path: |
          ~/.platformio
          .pio
        key: ${{ runner.os }}-pio-test-${{ hashFiles('**/platformio.ini') }}
        restore-keys: |
          ${{ runner.os }}-pio-test-
          ${{ runner.os }}-pio-
    
    - name: Install PlatformIO
      run: |
        python -m pip install --upgrade pip
        pip install platformio
    
    - name: Run build validation
      run: |
        echo "ðŸ”§ Running build validation for all board types..."
        make test || pio test \
          -e test-esp32-c3 \
          -e test-esp32-c6 \
          -e test-esp32 \
          -e test-esp32-s2 \
          -e test-esp32-s3 \
          -e test-esp32-s3-t-energy \
          -e test-esp32-s3-touch \
          -e test-jc2432w328c \
          --without-uploading --without-testing
    
    - name: Generate Summary
      if: always()
      run: |
        echo "### Build Validation Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Build validation completed**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "This validates that:" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Code compiles for all 8 board types" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… No syntax or configuration errors" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Pin definitions are valid" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Note:** Full firmware builds run on merge to main branch" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Time saved:** This test runs in ~2-3 minutes vs 15-20 minutes for full builds" >> $GITHUB_STEP_SUMMARY

