name: Test Flash Tool

on:
  # Run on releases/tags - test flash tool before release (like build-flasher.yml)
  release:
    types: [ published, created ]
  # Run on push to main/develop when flash_tool changes
  # CHANGE: Remove 'paths' filter if you want it to run on every push
  push:
    branches: [ main, master, develop ]
    paths:
      - 'flash_tool/**'
      - '.github/workflows/test-flash-tool.yml'
  # Allow PRs from same repo (security check in job)
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - 'flash_tool/**'
      - '.github/workflows/test-flash-tool.yml'
  # Manual trigger for testing
  workflow_dispatch:
  # OPTIONAL: Run on schedule (e.g., nightly tests)
  # Uncomment to enable:
  # schedule:
  #   - cron: '0 2 * * *'  # 2 AM UTC daily

jobs:
  # Test with hardware on self-hosted runner
  test-with-hardware:
    name: Test Flash Tool (With Hardware)
    # Security: Only use self-hosted runner for trusted events
    runs-on: self-hosted
    if: |
      (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/master')) ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository)
    
    steps:
    - name: Clean up any stale repository state
      if: runner.os == 'Linux'
      run: |
        # Remove any existing repository to prevent state conflicts
        if [ -d "${{ github.workspace }}" ] && [ -d "${{ github.workspace }}/.git" ]; then
          echo "Cleaning up stale repository state..."
          rm -rf "${{ github.workspace }}"/* "${{ github.workspace }}"/.* 2>/dev/null || true
        fi
    
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history (not shallow clone)
        fetch-tags: true  # Fetch all tags to prevent "bad object" errors
        ref: ${{ github.ref }}  # Explicitly set the ref
    
    - name: Verify repository state
      shell: bash
      run: |
        echo "Verifying repository state..."
        # Quick check - only verify if we can access the current ref
        if ! git rev-parse --verify HEAD >/dev/null 2>&1; then
          echo "⚠️ Repository state issue detected, attempting to repair..."
          git fetch --all --tags --force || true
          git gc --prune=now || true
        fi
        echo "✅ Repository state verified"
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: flash_tool/package-lock.json
    
    - name: Install system dependencies
      run: |
        # Check and install Xvfb if needed
        if ! command -v Xvfb &> /dev/null; then
          echo "Installing Xvfb..."
          sudo apt-get update
          sudo apt-get install -y xvfb
        fi
        
        # Check and install esptool if needed
        if ! command -v esptool.py &> /dev/null && ! command -v esptool &> /dev/null; then
          echo "Installing esptool..."
          pip3 install esptool || sudo pip3 install esptool
        fi
    
    - name: Install npm dependencies
      working-directory: flash_tool
      run: npm ci
    
    - name: Check for connected devices
      run: |
        echo "Checking for ESP32 devices..."
        echo "USB devices:"
        lsusb | grep -iE "silicon|wch|ch340|cp210" || echo "  No common ESP32 adapters found"
        echo ""
        echo "Serial devices:"
        ls -la /dev/ttyUSB* /dev/ttyACM* 2>/dev/null || echo "  No serial devices found"
        echo ""
        echo "Permissions:"
        groups | grep -q dialout && echo "  ✅ User in dialout group" || echo "  ⚠️ User not in dialout group (may need: sudo usermod -a -G dialout $USER)"
    
    - name: Setup virtual display
      run: |
        export DISPLAY=:99
        
        # Check if Xvfb is already running on this display
        if xdpyinfo -display :99 &>/dev/null; then
          echo "Display :99 already exists"
        else
          echo "Starting Xvfb on display :99..."
          Xvfb :99 -screen 0 1024x768x24 -ac +extension RANDR &
          sleep 2
          
          if xdpyinfo -display :99 &>/dev/null; then
            echo "✅ Xvfb started successfully"
          else
            echo "⚠️ Failed to start Xvfb, continuing anyway..."
          fi
        fi
    
    - name: Run flash tool tests
      working-directory: flash_tool
      run: |
        export DISPLAY=:99
        ./test/run-headless-tests.sh
      env:
        TEST_PORT: ${{ secrets.TEST_SERIAL_PORT }}
        TEST_FIRMWARE_DIR: ${{ github.workspace }}/test-firmware
        TEST_TIMEOUT: 120000  # 2 minutes timeout for hardware tests
      continue-on-error: true  # Don't fail if hardware not available
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: flash-tool-test-results
        path: |
          flash_tool/test/*.log
          flash_tool/test/*.json
        if-no-files-found: ignore
        retention-days: 7

  # Basic validation without hardware (runs on GitHub-hosted runners)
  test-validation:
    name: Test Flash Tool (Validation)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: flash_tool/package-lock.json
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb python3-pip
        pip3 install esptool
    
    - name: Install npm dependencies
      working-directory: flash_tool
      run: npm ci
    
    - name: Validate test scripts
      working-directory: flash_tool
      run: |
        echo "Validating test scripts..."
        [ -f "test/flash-test-suite.js" ] || exit 1
        [ -f "test/headless-test-runner.js" ] || exit 1
        [ -x "test/run-headless-tests.sh" ] || chmod +x test/run-headless-tests.sh
        echo "✅ Test scripts validated"
    
    - name: Setup virtual display
      run: |
        export DISPLAY=:99
        Xvfb :99 -screen 0 1024x768x24 &
        sleep 2
        xdpyinfo -display :99 > /dev/null || exit 1
    
    - name: Run basic validation tests
      working-directory: flash_tool
      run: |
        export DISPLAY=:99
        # Run tests without hardware - should skip hardware-dependent tests
        node test/flash-test-suite.js || echo "Tests skipped (expected without hardware)"
      env:
        TEST_TIMEOUT: 30000
      continue-on-error: true  # Don't fail - hardware tests require hardware

