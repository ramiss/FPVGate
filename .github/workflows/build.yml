name: Build PlatformIO Firmware

on:
  release:
    types: [ created, published ]  # Trigger on both created and published releases
  workflow_dispatch:  # Allows manual triggering

# Grant permissions for uploading to releases
permissions:
  contents: write  # Needed to upload release assets

jobs:
  # Build firmware only on releases (created or published) or manual dispatch
  build:
    runs-on: self-hosted
    strategy:
      # Run up to 8 jobs in parallel (one per board type)
      # Adjust this based on your runner's CPU cores and available resources
      max-parallel: 8
      matrix:
        environment:
          - esp32-c3-supermini
          - esp32-c3
          - nuclearcounter
          - esp32-c6
          - esp32dev
          - esp32-s3
          - esp32-s3-touch
          - esp32-s2
          - jc2432w328c
    
    steps:
    - name: Clean up any stale repository state
      if: runner.os == 'Linux'
      run: |
        # Remove any existing repository to prevent state conflicts
        if [ -d "${{ github.workspace }}" ] && [ -d "${{ github.workspace }}/.git" ]; then
          echo "Cleaning up stale repository state..."
          rm -rf "${{ github.workspace }}"/* "${{ github.workspace }}"/.* 2>/dev/null || true
        fi
    
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history (not shallow clone)
        fetch-tags: true  # Fetch all tags to prevent "bad object" errors
        ref: ${{ github.ref }}  # Explicitly set the ref
    
    - name: Verify repository state
      run: |
        echo "Verifying repository state..."
        # Quick check - only verify if we can access the current ref
        if ! git rev-parse --verify HEAD >/dev/null 2>&1; then
          echo "⚠️ Repository state issue detected, attempting to repair..."
          git fetch --all --tags --force || true
          git gc --prune=now || true
        fi
        echo "✅ Repository state verified"
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    # For self-hosted runners, PlatformIO packages persist in ~/.platformio
    # No need for GitHub Actions cache - packages are already cached locally
    # This significantly speeds up builds on self-hosted runners
    - name: Check PlatformIO cache
      run: |
        echo "PlatformIO packages location: ~/.platformio"
        du -sh ~/.platformio 2>/dev/null || echo "No PlatformIO cache yet"
        echo "First build will be slower (downloads packages), subsequent builds use cache"
    
    - name: Install PlatformIO
      run: |
        python -m pip install --upgrade pip
        # Use --user flag to avoid permission issues, or install system-wide
        pip install platformio
        # Verify PlatformIO installation
        pio --version
    
    - name: Clean build directory for ${{ matrix.environment }}
      run: pio run -e ${{ matrix.environment }} -t clean
      continue-on-error: true  # Ignore if no previous build exists
    
    - name: Build firmware for ${{ matrix.environment }}
      run: pio run -e ${{ matrix.environment }}
    
    - name: Build filesystem for ${{ matrix.environment }}
      run: |
        # Check if data directory exists before building SPIFFS
        if [ ! -d "data" ]; then
          echo "⚠️ WARNING: data/ directory not found. SPIFFS will be empty."
          echo "   SPIFFS contains web files (index.html, etc.) and should be built from data/ directory."
        else
          echo "Found data/ directory, building SPIFFS filesystem..."
          pio run -e ${{ matrix.environment }} --target buildfs
          if [ $? -eq 0 ]; then
            echo "✅ SPIFFS build successful"
          else
            echo "❌ SPIFFS build failed - continuing without SPIFFS"
          fi
        fi
      continue-on-error: true  # Continue even if SPIFFS build fails
    
    - name: Prepare artifacts
      run: |
        mkdir -p artifacts/${{ matrix.environment }}
        
        # Copy firmware binary
        if [ -f .pio/build/${{ matrix.environment }}/firmware.bin ]; then
          cp .pio/build/${{ matrix.environment }}/firmware.bin artifacts/${{ matrix.environment }}/
        fi
        
        # Copy bootloader and partitions (for manual flashing)
        if [ -f .pio/build/${{ matrix.environment }}/bootloader.bin ]; then
          cp .pio/build/${{ matrix.environment }}/bootloader.bin artifacts/${{ matrix.environment }}/
        fi
        if [ -f .pio/build/${{ matrix.environment }}/partitions.bin ]; then
          cp .pio/build/${{ matrix.environment }}/partitions.bin artifacts/${{ matrix.environment }}/
        fi
        
        # Copy filesystem binary
        if [ -f .pio/build/${{ matrix.environment }}/spiffs.bin ]; then
          SPIFFS_SIZE=$(stat -f%z .pio/build/${{ matrix.environment }}/spiffs.bin 2>/dev/null || stat -c%s .pio/build/${{ matrix.environment }}/spiffs.bin 2>/dev/null || echo "0")
          SPIFFS_SIZE_KB=$((SPIFFS_SIZE / 1024))
          echo "SPIFFS size: ${SPIFFS_SIZE_KB} KB"
          if [ "$SPIFFS_SIZE" -lt 1024 ]; then
            echo "⚠️ WARNING: SPIFFS is very small (${SPIFFS_SIZE} bytes). It may be empty."
          fi
          cp .pio/build/${{ matrix.environment }}/spiffs.bin artifacts/${{ matrix.environment }}/
        else
          echo "⚠️ WARNING: spiffs.bin not found for ${{ matrix.environment }}"
          echo "   SPIFFS filesystem was not built. Web files will not be available."
        fi
        
        # Create flash instructions
        cat > artifacts/${{ matrix.environment }}/FLASH_INSTRUCTIONS.txt << 'EOF'
        StarForge Firmware - ${{ matrix.environment }}
        ========================================
        
        Flash using esptool.py:
        -----------------------
        esptool.py --chip auto --port /dev/ttyUSB0 --baud 921600 write_flash \
          0x0000 bootloader.bin \
          0x8000 partitions.bin \
          0x10000 firmware.bin \
          0x290000 spiffs.bin
        
        Or use PlatformIO:
        ------------------
        pio run -e ${{ matrix.environment }} --target upload --upload-port /dev/ttyUSB0
        pio run -e ${{ matrix.environment }} --target uploadfs --upload-port /dev/ttyUSB0
        
        Built: $(date)
        Commit: ${{ github.sha }}
        EOF
    
    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ matrix.environment }}
        path: artifacts/${{ matrix.environment }}
    
    - name: Get firmware size info
      run: |
        echo "=== Build Information for ${{ matrix.environment }} ==="
        if [ -f .pio/build/${{ matrix.environment }}/firmware.elf ]; then
          pio run -e ${{ matrix.environment }} --target size
        fi

  # Create a combined release with all binaries
  release:
    needs: build
    if: github.event_name == 'release'
    # Use self-hosted runner for releases (trusted event)
    runs-on: self-hosted
    
    steps:
    - name: Install zip utility
      run: |
        # Install zip if not already installed (required for creating release packages)
        if ! command -v zip &> /dev/null; then
          sudo apt-get update && sudo apt-get install -y zip
        fi
        zip --version
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: all-firmware
    
    - name: Create release package
      run: |
        cd all-firmware
        for env in esp32-c3-supermini esp32-c3 nuclearcounter esp32-c6 esp32dev esp32-s3 esp32-s3-touch esp32-s2 jc2432w328c; do
          if [ -d "firmware-$env" ]; then
            cd "firmware-$env"
            zip -r "../StarForge-${env}.zip" .
            cd ..
          fi
        done
    
    - name: Upload to release
      uses: softprops/action-gh-release@v1
      with:
        files: all-firmware/*.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Summary job to show build status
  summary:
    needs: build
    # Summary can run on GitHub-hosted (lightweight)
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Build Summary
      run: |
        echo "### Build Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "✅ All firmware builds completed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Download artifacts from the Actions tab or releases page" >> $GITHUB_STEP_SUMMARY

